#!/bin/sh

set -u

current_mfsa() {
    local current
    current="$(
        torsocks --isolate curl --silent https://www.mozilla.org/en-US/security/advisories/ | \
           sed --regexp-extended -n 's@.*<a href="/en-US/security/advisories/(mfsa[0-9]+-[0-9]+)/".*>@\1@p' | \
           sort -n | \
           tail -n 1
    )"
    echo "$(date --rfc-3339=s): got ${current}" >&2
    echo "${current}"
}

initial="$(current_mfsa)"
while true; do
    new="$(current_mfsa)"
    [ -n "${new}" ] || continue
    if [ "${new}" != "${initial}" ]; then
	echo "${new}"
	exit 0
    fi
    sleep 60
done
